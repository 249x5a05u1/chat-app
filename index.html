<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Chat App</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { height: 100vh; overflow: hidden; }

.chat-app {
  display: flex;
  height: 100vh;
}

.sidebar {
  width: 25%;
  border-right: 1px solid #ddd;
  padding: 15px;
}

.chat-section {
  width: 75%;
  display: flex;
  flex-direction: column;
}

.messages {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.message {
  max-width: 60%;
  padding: 10px 15px;
  border-radius: 20px;
  margin-bottom: 10px;
}

.sent {
  align-self: flex-end;
  background: #0d6efd;
  color: white;
}

.received {
  align-self: flex-start;
  background: #e9ecef;
}

.typing {
  font-style: italic;
  font-size: 14px;
  margin-left: 10px;
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="container d-flex justify-content-center align-items-center vh-100">
  <div class="card p-4 shadow">
    <h4 class="text-center mb-3">Login</h4>
    <input type="text" id="username" class="form-control mb-3" placeholder="Enter username">
    <button class="btn btn-primary w-100" onclick="joinChat()">Enter Chat</button>
  </div>
</div>

<!-- CHAT APP -->
<div class="chat-app d-none" id="chatApp">

  <!-- Sidebar -->
  <div class="sidebar">
    <h5>Users</h5>
    <ul id="users" class="list-group"></ul>
    <button class="btn btn-sm btn-outline-secondary mt-3" onclick="toggleTheme()">Toggle Theme</button>
  </div>

  <!-- Chat Section -->
  <div class="chat-section">
    <div class="bg-primary text-white p-3">Global Chat</div>

    <div class="messages" id="messages"></div>
    <div class="typing" id="typing"></div>

    <div class="p-3">
      <div class="input-group">
        <input type="text" id="messageInput" class="form-control" placeholder="Type message..." oninput="typing()">
        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let currentUser = "";

function joinChat() {
  const username = document.getElementById("username").value.trim();
  if (!username) return;

  currentUser = username;
  socket.emit("join", username);

  document.getElementById("loginScreen").classList.add("d-none");
  document.getElementById("chatApp").classList.remove("d-none");
}

function sendMessage() {
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if (!text) return;

  socket.emit("message", text);
  input.value = "";
}

function typing() {
  socket.emit("typing");
}

socket.on("message", (data) => {
  const msgDiv = document.createElement("div");
  msgDiv.classList.add("message");

  if (data.user === currentUser) {
    msgDiv.classList.add("sent");
  } else {
    msgDiv.classList.add("received");
  }

  msgDiv.innerHTML = `<strong>${data.user}:</strong> ${data.text}`;
  document.getElementById("messages").appendChild(msgDiv);

  document.getElementById("messages").scrollTop =
    document.getElementById("messages").scrollHeight;

  localStorage.setItem("chatHistory",
    document.getElementById("messages").innerHTML);
});

socket.on("users", (users) => {
  const usersList = document.getElementById("users");
  usersList.innerHTML = "";
  users.forEach(user => {
    usersList.innerHTML += `<li class="list-group-item">${user}</li>`;
  });
});

socket.on("typing", (msg) => {
  document.getElementById("typing").innerText = msg;
  setTimeout(() => {
    document.getElementById("typing").innerText = "";
  }, 1000);
});

window.onload = () => {
  const history = localStorage.getItem("chatHistory");
  if (history) {
    document.getElementById("messages").innerHTML = history;
  }
};

function toggleTheme() {
  const html = document.documentElement;
  const theme = html.getAttribute("data-bs-theme");
  html.setAttribute("data-bs-theme", theme === "light" ? "dark" : "light");
}
</script>

</body>
</html>
